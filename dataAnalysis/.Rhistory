# Keep existing mplType values for non-span test trials
!(block == "span_mpl" & task == "spanTest") ~ mplType,
# For span test trials in span_mpl block, use the previous row's mplType
block == "span_mpl" & task == "spanTest" ~ lag(mplType),
# Default case
TRUE ~ mplType
)
)
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
block == "span_mpl" & task == "mpl" ~ lead(accuracy),
# Default case
TRUE ~ 1
)
)
dataPerParticipant$accuracy
# Extract MPL dataframes
mpl_dataframes <- extractMplDataframes(dataPerParticipant)
# Create base participant row
participant_row <- data.frame(
participant_id = participant_id,
demo_gend = demographics_df$demo_gend,
demo_educ = demographics_df$demo_educ,
demo_occu = demographics_df$demo_occu,
demo_reve = demographics_df$demo_reve,
demo_lsat = demographics_df$demo_lsat,
demo_age = demographics_df$demo_age,
spanLength = ifelse(length(spanLength) > 0, spanLength, NA),
treatment = treatment,
isLotteryFirst = isLotteryFirst,
numCorrectQuestionMirror = ifelse(length(numCorrectQuestionMirror) > 0, numCorrectQuestionMirror[1], NA),
numCorrectQuestionLottery = ifelse(length(numCorrectQuestionLottery) > 0, numCorrectQuestionLottery[1], NA),
payment_spanMpl = payment_spanMpl,
# payment_mpl = payment_mpl,
payment_spanSpan = payment_spanSpan,
payment_calibration = payment_calibration,
payment_total = payment_total,
stringsAsFactors = FALSE
)
# Define all possible combinations
mpl_types <- c("G10", "G25", "G50", "G75", "G90", "L10", "L25", "L50", "L75", "L90", "A10", "A15",
"GS10", "GS25", "GS50", "GS75", "GS90", "LS10", "LS25", "LS50", "LS75", "LS90", "AS10", "AS15")
status_types <- c("mirror", "lottery")
column_types <- c("ev", "rt", "subBlockNumber", "accuracy", "position")
# Initialize ALL possible MPL columns with NA values first
for(mpl_type in mpl_types) {
for(status_type in status_types) {
for(col_type in column_types) {
new_col_name <- paste0(mpl_type, "_", status_type, "_", col_type)
participant_row[[new_col_name]] <- NA
}
}
}
# Now add MPL data columns dynamically based on actual dataframes (this will overwrite the NAs where data exists)
for(df_name in names(mpl_dataframes)) {
df_data <- mpl_dataframes[[df_name]]
# Get all column names from this dataframe
col_names <- names(df_data) # ev, rt, subBlockNumber, accuracy
# For each column in the dataframe, update the corresponding column in participant_row
for(col_name in col_names) {
new_col_name <- paste0(df_name, "_", col_name)
# Update the column with the first row's value (overwriting the NA)
if(nrow(df_data) > 0) {
participant_row[[new_col_name]] <- df_data[[col_name]][1]
}
# If dataframe is empty, the NA value remains
}
}
# Add to final dataset
if(nrow(final_data) == 0) {
final_data <- participant_row
} else {
final_data <- rbind(final_data, participant_row)
}
cat("Processed participant", iSub, "\n")
}
view(dataPerParticipant)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ 2,
block == "span_mpl" & task == "mpl" ~ lead(task),
# Default case
TRUE ~ 1
)
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ "bb",
block == "span_mpl" & task == "mpl" ~ lead(task),
# Default case
TRUE ~ NA
)
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ "not block",
block == "span_mpl" & task == "mpl" ~ "block", #lead(task),
# Default case
TRUE ~ NA
)
)
View(dataPerParticipant)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ "not block",
block == "span_mpl" & task == "mpl" ~ designation, #lead(task),
# Default case
TRUE ~ NA
)
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ "not block",
block == "span_mpl" & task == "mpl" ~ designation, #lead(task),
# Default case
TRUE ~ NA
)
)
View(dataPerParticipant)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ "not block",
block == "span_mpl" & task == "mpl" ~ answer, #lead(task),
# Default case
TRUE ~ NA
)
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ answer, #lead(task),
# Default case
TRUE ~ NA
)
)
rlang::last_trace()
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ "not block",
block == "span_mpl" & task == "mpl" ~ trial_index, #lead(task),
# Default case
TRUE ~ NA
)
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ 99,
block == "span_mpl" & task == "mpl" ~ trial_index, #lead(task),
# Default case
TRUE ~ NA_real_
)
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ 99,
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task),
# Default case
TRUE ~ NA_real_
)
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ 99,
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task),
)
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ 99,
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task)
)
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ 99,
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task)
)
)
View(dataPerParticipant)
View(dataPerParticipant)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ trial_index,
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task)
)
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ lead(trial_index),
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task)
)
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task)
)
)
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task)
)
)
view(dataPerParticipant$accuracy)
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
rowwise %>%
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task)
)
)
view(dataPerParticipant$accuracy)
dataPerParticipant$accuracy
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant$trial_index
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
rowwise %>%
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ lead(trial_index),
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task)
)
)
view(dataPerParticipant$accuracy)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
rowwise %>%
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ trial_index, #lead(task)
)
)
view(dataPerParticipant$accuracy)
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
rowwise %>%
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ trial_index, #lead(task)
)
)
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
rowwise %>%
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task)
)
)
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
rowwise %>%
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ trial_index, #lead(task)
)
)
view(dataPerParticipant$accuracy)
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
rowwise %>%
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ trial_index, #lead(task)
)
)
dataPerParticipant$accuracy
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ trial_index, #lead(task)
)
)
dataPerParticipant$accuracy
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task)
)
)
dataPerParticipant$accuracy
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ trial_index, #lead(task)
)
)
dataPerParticipant$accuracy
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
)
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ lag(trial_index), #lead(task)
)
)
dataPerParticipant$accuracy
dataPerParticipant <- dataPerParticipant %>%
rowwise() %>%
mutate ( accuracy = case_when(
task == "spanTest" ~  accuracySpan(answer, correct), # & mplType != "" & block == "span_mpl"  !is.na(answer) & !is.null(correct) &
TRUE ~ NA_real_
),
.before = was_correct
) %>%
ungroup()
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ lag(trial_index), #lead(task)
)
)
dataPerParticipant$accuracy
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ lead(trial_index), #lead(task)
)
)
dataPerParticipant$accuracy
dataPerParticipant <- dataPerParticipant %>%
# Fill down accuracy for mpl trials
mutate(
accuracy = case_when(
# For span test trials in span_mpl block, use the next row's accuracy
!(block == "span_mpl" & task == "mpl") ~ accuracy,
block == "span_mpl" & task == "mpl" ~ lead(accuracy), #lead(task)
)
)
dataPerParticipant$accuracy
